<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="Build" ToolsVersion="12.0">
    
  <!--Importing the contents of other project files into this project -->  
   <Import Project="$(MSBuildExtensionsPath)\ExtensionPack\4.0\MSBuild.ExtensionPack.tasks"/>
   <Import Project="Properties.props"/>
  <ItemGroup>
	<SourceCodeDir Include="$(CITIATM_BASEDIR)\Source\**\*.*" Exclude="$(CITIATM_BASEDIR)\Source\**\bin\**;$(CITIATM_BASEDIR)\Source\bin\**;$(CITIATM_BASEDIR)\Source\**\binDebug\**;$(CITIATM_BASEDIR)\Source\**\obj\**;$(CITIATM_BASEDIR)\Source\**\Loquendo\**" />
	<K3ADir Include="$(CITIATM_BASEDIR)\K3A\**\*.*"/>
	<KaligniteDir Include="$(CITIATM_BASEDIR)\Kalignite\**\*.*"/>
	<SlnFiles Include="$(CODE_ANALYSIS_DIR)\Source\BuildAll.sln;$(CODE_ANALYSIS_DIR)\Source\A2IAImageProcessor.sln"> 
      <Properties>Configuration=Release;ToolsVersion=12.0</Properties>
    </SlnFiles>
  </ItemGroup>
  
	<Target Name="PreBuildCleanup">
	    <ItemGroup>
		  <Folders Include="$(CODE_ANALYSIS_DIR)"/>
		</ItemGroup> 
		<RemoveDir Condition="Exists('%(Folders.Identity)')" Directories="%(Folders.Identity)"/> 
		<MakeDir Directories="%(Folders.Identity)"/>
	</Target>
	
	<Target Name="Build" DependsOnTargets="CopySourceCode;CodeScanInit;BuildCitiATM;CodeScan">
		<Message Text="Initiated Sonar Build"/>
	</Target>
  
	<Target Name="CopySourceCode">
		<Message Text="Copying Source Code to a local folder"/>
		<Copy SourceFiles="@(SourceCodeDir)" DestinationFolder="$(CODE_ANALYSIS_DIR)\Source\%(RecursiveDir)" />
		<Copy SourceFiles="@(K3ADir)" DestinationFolder="$(CODE_ANALYSIS_DIR)\K3A\%(RecursiveDir)" />
		<Copy SourceFiles="@(KaligniteDir)" DestinationFolder="$(CODE_ANALYSIS_DIR)\Kalignite\%(RecursiveDir)" />
	</Target>
	
	<Target Name="BuildCitiATM">
		<Message Text="Building all solution projects"/>
		<!--<MSBuild Targets="Rebuild" Projects="@(SlnFiles)"/>-->
		<Exec Command="msbuild.exe $(CODE_ANALYSIS_DIR)\Source\BuildAll.sln /t:Rebuild /p:Configuration=Release;ToolsVersion=12.0" 
				WorkingDirectory="$(CODE_ANALYSIS_DIR)"/>
		<Exec Command="msbuild.exe $(CODE_ANALYSIS_DIR)\Source\A2IAImageProcessor.sln /t:Rebuild /p:Configuration=Release;ToolsVersion=12.0" 
				WorkingDirectory="$(CODE_ANALYSIS_DIR)"/>
	</Target>
  
    <Target Name="CodeScanInit">
     <Message Text="Starting SonarScanner"/>
	 <!--<Exec Command="MSBuild.SonarQube.Runner.exe begin /k:$(CITIATMVERSION.Replace(' ','')) /n:&quot;$(CITIATMVERSION) (Global)&quot; /v:$(CitiATMHO)" WorkingDirectory="$(CODE_ANALYSIS_DIR)"/>-->
	 <Exec Command="MSBuild.SonarQube.Runner.exe begin /k:$(CODE_ANALYSIS_PROJECT_KEY) /n:&quot;$(CITIATMVERSION) ($(CODE_ANALYSIS_BUSINESS))&quot; /v:$(CitiATMHO)$(Patch)" WorkingDirectory="$(CODE_ANALYSIS_DIR)"/>
   </Target>
  
    <Target Name="CodeScan">
		<Exec Command="MSBuild.SonarQube.Runner.exe end" WorkingDirectory="$(CODE_ANALYSIS_DIR)"/>
    </Target>
	
  	<Target Name="PostBuildCleanup">
		<RemoveDir Condition="Exists('$(CODE_ANALYSIS_DIR)')" Directories="$(CODE_ANALYSIS_DIR)"/>
	</Target>
</Project>